<!--
 - Copyright (c) 2018. Barrett Business Services, Inc. All Rights Reserved
 - Created by agoganian on 10/15/2018.
 -->
 <aura:component controller="PrcEmployeesController" implements="force:hasRecordId,flexipage:availableForAllPageTypes" access="global">

	<!-- Attributes -->
	<aura:attribute name="eeTableHeight" type="String" default="height:auto" access="public"/>
	<aura:attribute name="wcCodeList" type="sObject"/>
	<aura:attribute name="projFactor" type="Decimal" default="1" />
	<aura:attribute name="wcCode" type="PricingWcCode__c"/>

	<!-- Add Button - Create New Employee Attributes -->
	<aura:attribute name="showAddEmployee" type="Boolean" default="false"/>
	<aura:attribute name="newEmployee" type="PricingEmployee__c"/>

	<!-- Modify by WC Code Button - Add/Subs Work Comp Attributes-->
	<aura:attribute name="showModifyByWcCode" type="Boolean" default="false"/>
	<aura:attribute name="newWc" type="PricingEmployee__c"/>

	<!-- Pricing Attributes -->
	<aura:handler event="c:FluxContainer_getState" action="{!c.onAppEvent}"/>
	<aura:registerEvent name="setState" type="c:FluxContainer_setState"/>
	<aura:attribute name="containerName" type="String" default="employees"/>

	<!-- pricing datasets -->


	<!-- Footer Attributes -->
	<aura:attribute name="totalEmployees" type="Decimal" default="0"/>
	<aura:attribute name="activeEmployees" type="Decimal" default="0"/>
	<aura:attribute name="annualHours" type="Decimal" default="0"/>
	<aura:attribute name="annualPay" type="Decimal" default="0"/>
	<aura:attribute name="estTaxes" type="Decimal" default="0"/>
	<aura:attribute name="taxBurdenPercent" type="Decimal" default="0"/>
	<aura:attribute name="taxBurdenPercentNoOwner" type="Decimal" default="0"/>

	<!-- Common Attributes -->
	<aura:attribute name="clientId" type="String"/>
	<aura:attribute name="data" type="sObject"/>
	<aura:attribute name="clientPricScenId" type="String"/>
	<aura:attribute name="sObjectType" type="String" required="true" default="PricingEmployee__c" access="public" />
	<aura:attribute name="maxRows" type="Integer" default="20" />
	<aura:attribute name="records" type="Object[]" />
	<aura:attribute name="columns" type="List" />
	<aura:attribute name="isLoading" type="Boolean" default="false"/>
	<aura:attribute name="isProspect" type="Boolean" default="false"/>

	<!-- Sorting fields in Employees table -->
	<aura:attribute name="sortedBy" type="String"/>
	<aura:attribute name="sortedDirection" type="String"/>
	<aura:attribute name="defaultSortDirection" type="String"/>

	<!-- Subtotal Table for Payroll -->
	<aura:attribute name="wcSummaryData" type="sObject"/>
	<aura:attribute name="wcSummaryColumns" type="List" />

	<!-- Common Handlers -->
	<aura:handler name="init" value="{!this}" action="{!c.init}" />
	
	<!-- Common Libraries -->
	<lightning:notificationsLibrary aura:id="notifLib"/>

	<div class="slds-text-heading_small slds-p-bottom--small">
		PAYROLL AND EMPLOYER TAXES
	</div>
	<div style="{!v.eeTableHeight}">
		<lightning:datatable
				aura:id = "employeesTable"
				keyField="Id"
				data="{! v.data }"
				columns="{! v.columns }"
				onsave="{!c.handleSaveTable}"
				onrowaction="{! c.handleRowAction}"
				hideCheckboxColumn="true"
				sortedBy="{! v.sortedBy }"
				sortedDirection="{! v.sortedDirection }"
				defaultSortDirection="{! v.defaultSortDirection }"
				onsort="{! c.handleColumnSorting}"/>
	</div>

	<!-- Buttons: Add (New Employee) -->
	<div class="slds-m-top_small">
		<aura:renderif isTrue="{! !v.showAddEmployee}">
			<lightning:button label="Add" variant="brand" onclick="{!c.onOpenAddEmployeeForm}"/>
		</aura:renderif>
	</div>

	<!-- Add New Employee Dialog -->
	<aura:renderif isTrue="{! v.showAddEmployee}">
		<div aria-labelledby="newEmployeeForm" >
			<!-- BOXED AREA -->
			<fieldset class="slds-box slds-theme--default slds-container--small">
				<legend id="newEmployeeForm" class="slds-text-heading--small slds-p-vertical--medium"></legend>
				<!-- CREATE NEW EMPLOYEE FORM -->
				<form class="slds-form--stacked">
					<lightning:input aura:id="employeeform" label="Name (required)"
									 name="employeeName"
									 value="{!v.newEmployee.Employee_Name__c}"
									 placeholder="Name"
									 required="true"/>
					<lightning:input type="number" aura:id="employeeform" label="Quantity (required)"
									 name="employeeQty"
									 min="1"
									 value="{!v.newEmployee.Qty__c}"
									 required="true"
									 messageWhenRangeUnderflow="Enter at least 1"/>
					<lightning:input type="checkbox" aura:id="employeeform" label="Owner"
									 name="employeeIsOwner"
									 checked="{!v.newEmployee.IsOwner__c}"/>
					<lightning:select aura:id="employeeform" label="Select Primary WC Code (required)"
									  name="employeePrimaryWcCode" value="{!v.newEmployee.PrimaryPricingWcCode__c}">
						<option value="">Select a WC Code</option>
						<aura:iteration items="{!v.wcCodeList}" var="wcOption">
							<option text="{!wcOption.label}" value="{!wcOption.Id}" selected="{!wcOption.selected}"/>
						</aura:iteration>
					</lightning:select>
					<lightning:input type="checkbox" aura:id="employeeform" label="Active" name="employeeActive"
									 checked="{!v.newEmployee.IsActive__c}"/>
					<lightning:input type="number" aura:id="employeeform" label="Annual Hours" name="employeeHours"
									 step="0.1" value="{!v.newEmployee.AnnualHours__c}"/>
					<lightning:input type="number" aura:id="employeeform" label="Annual Payroll (required)" name="employeePay"
									 formatter="currency" step="0.01" required="true" value="{!v.newEmployee.AnnualPay__c}"/>
					<lightning:button label="Submit" class="slds-m-top--medium" variant="brand" onclick="{!c.onCreateEE}"/>
					<lightning:button label="Cancel" class="slds-m-top--medium" variant="brand" onclick="{!c.onCancelEE}"/>
				</form>
				<!-- / CREATE NEW EMPLOYEE FORM -->

			</fieldset>
			<!-- / BOXED AREA -->
		</div>
	</aura:renderif>

	<!--  EMPLOYEE TABLE FOOTER -->
	<div class="slds-grid slds-grid_align-center slds-p-top--small slds-p-bottom_large" id="employeesFooter">
		<div class="slds-align-top slds-col slds-size--1-of-1 slds-p-bottom--small" >
			<table class="slds-table slds-table_cell-buffer slds-table_bordered slds-no-row-hover">
				<thead>
				<tr class="slds-line-height_reset">
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Tax Burden %">Tax Burden %</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Tax Burden % w/o Owner">Tax Burden % w/o Owner</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Total Employees">Total Employees</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Total Active Employees">Active Employees</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Annual Hours">Annual Hours</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Annual Payroll">Annual Payroll</div>
					</th>
					<th class="slds-text-title_caps" scope="col">
						<div class="slds-truncate" align="center" title="Estimated Employer Taxes">Estimated Employer Taxes</div>
					</th>
				</tr>
				</thead>
				<tbody>
				<tr class="slds-hint-parent">
					<td>
						<div class="slds-truncate" align="center" title="Tax Burden %">
							<ui:outputNumber format="##0.00" value="{!v.taxBurdenPercent}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center" title="Tax Burden % w/o Owner">
							<ui:outputNumber format="##0.00" value="{!v.taxBurdenPercentNoOwner}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center" title="{!v.totalEmployees}">
							<ui:outputNumber format="##0.0" value="{!v.totalEmployees}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center" title="{!v.activeEmployees}">
							<ui:outputNumber format="##0.0" value="{!v.activeEmployees}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center">
							<ui:outputNumber format="#,##0.0" value="{!v.annualHours}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center">
							<ui:outputCurrency value="{!v.annualPay}"/>
						</div>
					</td>
					<td>
						<div class="slds-truncate" align="center">
							<ui:outputCurrency value="{!v.estTaxes}"/>
						</div>
					</td>
				</tr>
				</tbody>
			</table>
		</div>
	</div>

	<div class="slds-text-heading_small slds-p-bottom--small">
		PAYROLL SUMMARY BY WC CODE
	</div>
	<!-- Summary Employees Payroll Table -->
	<div style="height:auto">
		<lightning:datatable
				aura:id = "summaryEmployeesTable"
				keyField="Id"
				data="{! v.wcSummaryData }"
				columns="{! v.wcSummaryColumns }"
				hideCheckboxColumn="true"/>
	</div>

	<!-- Button: Modify WC Code -->
	<div class="slds-m-top_small">
		<aura:renderif isTrue="{! !v.showModifyByWcCode}">
			<lightning:button label="Modify by WC Code" variant="brand" onclick="{!c.onOpenModifyWorkCompForm}"/>
		</aura:renderif>
	</div>

	<!-- Modify by Work Comp Dialog -->
	<aura:renderif isTrue="{! v.showModifyByWcCode}">
		<div aria-labelledby="modifyWcCodeForm" >
			<!-- BOXED AREA -->
			<fieldset class="slds-box slds-theme--default slds-container--small">
				<legend id="modifyWcCodeForm" class="slds-text-heading--small slds-p-vertical--medium"></legend>
				<!-- Modify WC Code Form -->
				<form class="slds-form--stacked">
					<lightning:select aura:id="modifyWcForm" label="Select WC Code (required)"
									  name="primaryWcCode" value="{!v.newWc.PrimaryPricingWcCode__c}">
						<option value="">Select a WC Code</option>
						<aura:iteration items="{!v.wcCodeList}" var="wcOption">
							<option text="{!wcOption.label}" value="{!wcOption.Id}" selected="{!wcOption.selected}"/>
						</aura:iteration>
					</lightning:select>
					<lightning:input type="number" aura:id="modifyWcForm" label="Amount to Adjust Payroll"
									 name="wcPay"
									 formatter="currency"
									 step="0.01"
									 required="true"
									 value="{!v.newWc.AnnualPay__c}"/>
					<lightning:input type="number" aura:id="modifyWcForm" label="# of Employees to Add/Subtract"
									 name="employeeQty"
									 onchange="{!c.modifyNumberOfEmployees}"
									 required="true"
									 value="{!v.newWc.Qty__c}"/>
					<lightning:input type="number" aura:id="modifyWcForm" label="Hours to Add/Subtract"
									 name="wcHours" step="0.1"
									 required="true"
									 value="{!v.newWc.AnnualHours__c}"/>
					<lightning:button label="Submit" class="slds-m-top--medium" variant="brand" onclick="{!c.onModifyWcCode}"/>
					<lightning:button label="Cancel" class="slds-m-top--medium" variant="brand" onclick="{!c.onCancelWcCode}"/>
				</form>
				<!-- / CREATE NEW EMPLOYEE FORM -->

			</fieldset>
			<!-- / BOXED AREA -->
		</div>
	</aura:renderif>
</aura:component>